FROM 448613307115.dkr.ecr.eu-west-1.amazonaws.com/jvm-oracle:1.8.0_102-b14

ENV JETTY_HOME="/usr/local/jetty" \
    SUN_NET_INETADDR_TTL="60" \
    MBST_PLATFORM="stage" \
    MONGO_POOLSIZE="50" \
    ATLAS_SEARCH_HOST="http://search1.stage.atlas.mbst.tv:8181" \
    CASSANDRA_CONNECTIONTIMEOUT="60000" \
    CASSANDRA_KEYSPACE="Atlas_Stage" \
    CASSANDRA_PORT="9160" \
    CASSANDRA_REQUESTTIMEOUT="60000" \
    CASSANDRA_SEEDS="cassandra1.deer.atlas.mbst.tv,cassandra2.deer.atlas.mbst.tv,cassandra3.deer.atlas.mbst.tv" \
    EQUIV_RESULTS_DIRECTORY="/mnt/equiv-results" \
    EVENTS_WHITELIST_IDS="hpj4,hpj6,hpj5,hpj7,hpck,hpws,hpdg,hpwy,hpkm,hpkk,hq87,hq88,hpkn" \
    IDS_EXPOSE="true" \
    IDS_GENERATE="true" \
    LOCAL_HOST_NAME="stage.atlas.metabroadcast.com" \
    MESSAGING_BROKER_URL="node1.kafka.mbst.tv:9092,node2.kafka.mbst.tv:9092,node3.kafka.mbst.tv:9092,node4.kafka.mbst.tv:9092" \
    MESSAGING_DESTINATION_EQUIV_ASSERT="EquivAssert" \
    MESSAGING_ENABLED="true" \
    MESSAGING_ZOOKEEPER="node1.kafka.mbst.tv:2181,node2.kafka.mbst.tv:2181,node3.kafka.mbst.tv:2181" \
    MONGO_DB_TAG="az:eu-west-1c" \
    MONGO_DB_TAG_FALLBACK="all:all" \
    MONGO_DBNAME="atlas-split" \
    MONGO_HOST="db1.stage.atlas.mbst.tv" \
    PA_SCHEDULE_HEALTH_PASSWORD="" \
    PA_SCHEDULE_HEALTH_USERNAME="monitoring" \
    PROCESSING_CONFIG="false" \
    REQUEST_THREADS="40" \
    RP_FTP_ENABLED="false" \
    RP_FTP_MANUALUPLOAD_ENABLED="false" \
    RP_FTP_SERVICES="0" \
    RP_HEALTH_PASSWORD="" \
    RP_HTTPS_BASEURL="https://dev02.radioplayer.co.uk/ingestor/metadata/v1" \
    RP_HTTPS_MANUALUPLOAD_ENABLED="true" \
    RP_HTTPS_SERVICES="all" \
    RP_HTTPS_PASSWORD="" \
    RP_HTTPS_USERNAME="bbcingest" \
    RP_PASSWORD_AUTONOMY="" \
    RP_PASSWORD_UNIQUE="" \
    RP_UPLOAD_AUTONOMY="ukradioplayer.autonomycloud.com|21|BBC" \
    RP_UPLOAD_UNIQUE="ingest.radioplayer.co.uk|21|bbc" \
    SERVER_PORT="8080" \
    SERVICE_WEB_ID="19683" \
    SITEMAPS_C4_BRIGHTCOVE_PLAYERID="2838875326001" \
    SITEMAPS_C4_BRIGHTCOVE_PUBLISHERID="2714262763001" \
    SITEMAPS_C4_FLASHPLAYERVERSION="12_05" \
    SITEMAPS_C4_FLASHPLAYERVERSION_URI="http://www.channel4.com/static/programmes-bips-flash/flashVersion.js" \
    TWITTER_AUTH_CONSUMERKEY="BvVeHDlcMPxyKzGbM6JYw" \
    TWITTER_AUTH_CONSUMERSECRET="" \
    WATERMARK_CHANNELURIS="http://www.bbc.co.uk/services/bbctwo/england" \
    JSSE_ENABLESNIEXTENSION="false" \
    HTTP_NONPROXYHOSTS="localhost|*.mbst.tv|*.metabroadcast.com|*.atlasapi.org" \
    HTTP_PROXYHOST="lb.proxy.mbst.tv" \
    HTTP_PROXYPORT="3128" \
    HTTPS_PROXYHOST="lb.proxy.mbst.tv" \
    HTTPS_PROXYPORT="3128" \
    LOG4J_CONFIGURATION="file:////usr/local/jetty/log4j.properties" \
    NIMROD_LOG_LEVEL="INFO" \
    ROOT_LOG_LEVEL="INFO" \
    JVM_MEMORY="5500m" \
    JVM_OPTS="-XX:+UseG1GC \
      -XX:MaxGCPauseMillis=150 \
      -XX:CMSInitiatingOccupancyFraction=60 \
      -XX:+ExitOnOutOfMemoryError"

RUN mkdir -p /mnt/equiv-results

COPY target/atlas.war /usr/local/jetty/atlas.war
COPY log4j.properties /usr/local/jetty/log4j.properties

WORKDIR /usr/local/jetty

CMD java \
    -Djetty.home="$JETTY_HOME" \
    -Dsun.net.inetaddr.ttl="$SUN_NET_INETADDR_TTL" \
    -DMBST_PLATFORM="$MBST_PLATFORM" \
    -DMONGO_POOLSIZE="$MONGO_POOLSIZE" \
    -Datlas.search.host="$ATLAS_SEARCH_HOST" \
    -Dcassandra.cluster="$CASSANDRA_CLUSTER" \
    -Dcassandra.connectionTimeout="$CASSANDRA_CONNECTIONTIMEOUT" \
    -Dcassandra.keyspace="$CASSANDRA_KEYSPACE" \
    -Dcassandra.port="$CASSANDRA_PORT" \
    -Dcassandra.requestTimeout="$CASSANDRA_REQUESTTIMEOUT" \
    -Dcassandra.seeds="$CASSANDRA_SEEDS" \
    -Dequiv.results.directory="$EQUIV_RESULTS_DIRECTORY" \
    -Devents.whitelist.ids="$EVENTS_WHITELIST_IDS" \
    -Dids.expose="$IDS_EXPOSE" \
    -Dids.generate="$IDS_GENERATE" \
    -Dlocal.host.name="$LOCAL_HOST_NAME" \
    -Dmessaging.broker.url="$MESSAGING_BROKER_URL" \
    -Dmessaging.destination.equiv.assert="$MESSAGING_DESTINATION_EQUIV_ASSERT" \
    -Dmessaging.enabled="$MESSAGING_ENABLED" \
    -Dmessaging.zookeeper="$MESSAGING_ZOOKEEPER" \
    -Dmongo.db.tag="$MONGO_DB_TAG" \
    -Dmongo.db.tag.fallback="$MONGO_DB_TAG_FALLBACK" \
    -Dmongo.dbName="$MONGO_DBNAME" \
    -Dmongo.host="$MONGO_HOST" \
    -Dpa.schedule.health.password="$PA_SCHEDULE_HEALTH_PASSWORD" \
    -Dpa.schedule.health.username="$PA_SCHEDULE_HEALTH_USERNAME" \
    -Dprocessing.config="$PROCESSING_CONFIG" \
    -Drequest.threads="$REQUEST_THREADS" \
    -Drp.ftp.enabled="$RP_FTP_ENABLED" \
    -Drp.ftp.manualUpload.enabled="$RP_FTP_MANUALUPLOAD_ENABLED" \
    -Drp.ftp.services="$RP_FTP_SERVICES" \
    -Drp.health.password="$RP_HEALTH_PASSWORD" \
    -Drp.https.baseUrl="$RP_HTTPS_BASEURL" \
    -Drp.https.manualUpload.enabled="$RP_HTTPS_MANUALUPLOAD_ENABLED" \
    -Drp.https.password="$RP_HTTPS_PASSWORD" \
    -Drp.https.services="$RP_HTTPS_SERVICES" \
    -Drp.https.username="$RP_HTTPS_USERNAME" \
    -Drp.password.autonomy="$RP_PASSWORD_AUTONOMY" \
    -Drp.password.unique="$RP_PASSWORD_UNIQUE" \
    -Drp.upload.autonomy="$RP_UPLOAD_AUTONOMY" \
    -Drp.upload.unique="$RP_UPLOAD_UNIQUE" \
    -Dserver.port="$SERVER_PORT" \
    -Dservice.web.id="$SERVICE_WEB_ID" \
    -Dsitemaps.c4.brightcove.playerId="$SITEMAPS_C4_BRIGHTCOVE_PLAYERID" \
    -Dsitemaps.c4.brightcove.publisherId="$SITEMAPS_C4_BRIGHTCOVE_PUBLISHERID" \
    -Dsitemaps.c4.flashplayerversion="$SITEMAPS_C4_FLASHPLAYERVERSION" \
    -Dsitemaps.c4.flashplayerversion.uri="$SITEMAPS_C4_FLASHPLAYERVERSION_URI" \
    -Dtwitter.auth.consumerKey="$TWITTER_AUTH_CONSUMERKEY" \
    -Dtwitter.auth.consumerSecret="$TWITTER_AUTH_CONSUMERSECRET" \
    -Dwatermark.channelUris="$WATERMARK_CHANNELURIS" \
    -Djsse.enableSNIExtension="$JSSE_ENABLESNIEXTENSION" \
    -Dhttp.nonProxyHosts="$HTTP_NONPROXYHOSTS" \
    -Dhttp.proxyHost="$HTTP_PROXYHOST" \
    -Dhttp.proxyPort="$HTTP_PROXYPORT" \
    -Dhttps.proxyHost="$HTTPS_PROXYHOST" \
    -Dhttps.proxyPort="$HTTPS_PROXYPORT" \
    -Dlog4j.configuration="$LOG4J_CONFIGURATION" \
    -Dnimrod.log.level="$NIMROD_LOG_LEVEL" \
    -Droot.log.level="$ROOT_LOG_LEVEL" \
    -Xmx$JVM_MEMORY \
    -Xms$JVM_MEMORY \
    $JVM_OPTS \
    -jar atlas.war
